import os
import sys
import datetime
import urllib
import simplejson
import time
import commands
import calendar

ACCESS_TOKENs = ["f87c1f7a11068f88b59cef73c76aa68d3d6afbf0","a09e60c0157cafb6690b7080ae5bbc1bff770b79", "adcaa627c8f484500c7282c6586fe042c3f0f831", "8af406e80fcf4058cacbeab977c13e1ec7bb1f88", "62b073788da906ce742bc1def6402d1463c7251a"]

def GetBitlyJson(URL):	
	json = ""
	for access_token in ACCESS_TOKENs:
		URL = URL.replace("ACCESS_TOKEN", access_token)
		command = 'curl --silent -L -A "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_6_8) AppleWebKit/534.30 (KHTML, like Gecko) Chrome/12.0.742.112 Safari/534.30" "'+URL+'"'
		page = commands.getoutput(command)
		page = page.encode('ascii', 'ignore')
		if(page.find('"error": "NOT_FOUND"')!=-1):
			break
		json = simplejson.loads(page)
		if(json['status_code']==403):
			continue
	return json

def getBitlyCreationDate(url):
	try:
		# Get aggregated url
		URL = "https://api-ssl.bitly.com/v3/link/lookup?access_token=ACCESS_TOKEN&url="+url
		json = GetBitlyJson(URL)
		if('error' in json['data']['link_lookup'][0]  and json['data']['link_lookup'][0]['error']=='NOT_FOUND'):
			return ""
		url = json['data']['link_lookup'][0]['aggregate_link']

		# Get creation timestamp
		URL = "https://api-ssl.bitly.com/v3/info?access_token=ACCESS_TOKEN&shortUrl="+url
		json = GetBitlyJson(URL)
	
		if(json['data'] == None or 'created_at' not in json['data']['info'][0]):
			return ""
		epoch = json['data']['info'][0]['created_at']

		limitEpoch = int(calendar.timegm(time.strptime("1995-01-01T12:00:00", '%Y-%m-%dT%H:%M:%S')))
		if(limitEpoch<epoch):
			return ""

		creation_date = time.strftime('%Y-%m-%dT%H:%M:%S', time.gmtime(epoch))

		return str(creation_date)
	
	except:
		print sys.exc_info()
		return ""

